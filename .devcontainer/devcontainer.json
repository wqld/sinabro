// For format details, see https://aka.ms/devcontainer.json. For config options, see the
// README at: https://github.com/devcontainers/templates/tree/main/src/rust
{
  "name": "Rust",
  // Or use a Dockerfile or Docker Compose file. More info: https://containers.dev/guide/dockerfile
  "image": "mcr.microsoft.com/devcontainers/rust:1-1-bullseye",
  "privileged": true,

  "features": {
    "ghcr.io/devcontainers/features/docker-outside-of-docker:1": {},
    "ghcr.io/mpriscella/features/kind:1": {}
  },

  // Use 'mounts' to make the cargo cache persistent in a Docker Volume.
  // "mounts": [
  // 	{
  // 		"source": "devcontainer-cargo-cache-${devcontainerId}",
  // 		"target": "/usr/local/cargo",
  // 		"type": "volume"
  // 	}
  // ]

  // Features to add to the dev container. More info: https://containers.dev/features.
  // "features": {},

  // Use 'forwardPorts' to make a list of ports inside the container available locally.
  // "forwardPorts": [],

  // Use 'postCreateCommand' to run commands after the container is created.
  "postCreateCommand": "sudo apt update && sudo apt install -y lsb-release wget software-properties-common gnupg vim && sudo bash -c \"$(wget -O - https://apt.llvm.org/llvm.sh)\" && sudo apt autoremove -y && echo 'export PATH=$(llvm-config-17 --prefix)/bin:$PATH' >> ~/.bashrc && export PATH=$(llvm-config-17 --prefix)/bin:$PATH && sudo apt install -y libpolly-17-dev libzstd-dev musl-tools gcc-aarch64-linux-gnu && sudo ln -s /usr/bin/aarch64-linux-gnu-gcc /usr/bin/aarch64-linux-musl-gcc && rustup install stable && rustup toolchain install nightly --component rust-src && rustup target add aarch64-unknown-linux-musl && cargo install --no-default-features bpf-linker && curl -LO \"https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/arm64/kubectl\" && sudo install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl && chmod +x kubectl && mkdir -p ~/.local/bin && mv ./kubectl ~/.local/bin/kubectl",

  // Configure tool-specific properties.
  // "customizations": {},

  // Uncomment to connect as root instead. More info: https://aka.ms/dev-containers-non-root.
  "remoteUser": "root",
  "runArgs": ["--network=host"]
}
